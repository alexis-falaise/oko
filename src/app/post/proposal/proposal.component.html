<div class="proposal-title-wrapper" *ngIf="standalone">
  <h2 class="proposal-title">Proposition {{ proposal?.closed ? '(annulée)' : '' }}</h2>
  <div class="proposal__author-details" *ngIf="proposal?.author && !proposal.authorView">
      <app-avatar class="proposal__author-details__avatar" [image]="proposal?.author?.avatar" [size]="36"></app-avatar>
      <div class="proposal__author-details__personnal">
          de {{ proposal?.author?.firstname }}
          <app-rating [rating]="proposal.author.rating" [size]="36" [light]="true"></app-rating>
      </div>
  </div>
</div>
<div *ngIf="proposal" [ngClass]="{'proposal': true, 'standalone container': standalone, 'closed': standalone && proposal.closed}">
    <div class="row justify-content-around proposal__actions">
        <button class="btn btn-light btn-icon"
                *ngIf="proposal.authorView && !proposal.closed && !proposal.accepted && !proposal.refused"
                (click)="modifyProposal()">
          <mat-icon>edit</mat-icon> Modifier
        </button>
        <button class="btn btn-success btn-icon"
                [disabled]="proposal.accepted || proposal.refused || proposal.closed"
                *ngIf="receiver"
                (click)="acceptProposal()">
          <mat-icon>done</mat-icon> {{ proposal.accepted ? 'Acceptée' : 'Accepter' }}
        </button>
        <button class="btn btn-success btn-icon"
                [disabled]="proposal.paid"
                *ngIf="proposal.authorView && proposal.accepted">
          <mat-icon>credit_card</mat-icon> {{ proposal.paid ? 'Payée' : 'Payer' }}
        </button>
        <button class="btn btn-success btn-icon"
                [disabled]="proposal.validated"
                *ngIf="receiver && proposal.accepted && proposal.paid"
                (click)="validateProposal()">
          <mat-icon>done_all</mat-icon> {{ proposal.validated ? 'Réception confirmée' : 'Confirmer la réception' }}
        </button>
        <button class="btn btn-danger btn-icon"
                [disabled]="proposal.refused"
                *ngIf="receiver && !proposal.accepted && !proposal.closed"
                (click)="refuseProposal()">
          <mat-icon>clear</mat-icon> {{ proposal.refused ? 'Refusée' : 'Refuser' }}
        </button>
        <button class="btn btn-danger btn-icon"
                [disabled]="proposal.closed"
                *ngIf="proposal.authorView"
                (click)="closeProposal()">
          <mat-icon>clear</mat-icon>{{ proposal.closed ? 'Annulée' : 'Annuler' }}
        </button>
    </div>
    <hr class="divider" *ngIf="proposal.bonus">
    <div class="proposal__summary">
        <h6 class="text-muted" *ngIf="proposal.bonus">Bonus voyageur: {{ proposal.bonus }} €</h6>
        <small class="text-muted" *ngIf="proposal.lastUpdate">
          Dernière modification {{ moment(proposal.lastUpdate.date).fromNow() }} par {{ proposal.lastUpdate.author?.firstname || 'Oko user' }}
        </small>
        <div class="d-flex w-100 justify-content-center">
          <button class="btn btn-light btn-sm btn-icon"
                  *ngIf="!proposal.closed && !proposal.accepted && !proposal.refused && proposal.bonus"
                  (click)="modifyProposal()">
            <mat-icon>edit</mat-icon> Contre proposition
          </button>
        </div>
    </div>
    <hr class="divider" *ngIf="proposal.from && !self">
    <div class="proposal__trip" *ngIf="fromTrip; else fromRequest" (click)="openTrip(proposal.from)">
        <div class="proposal__trip-date">
            <div class="arrival">
                <mat-icon>today</mat-icon> Arrivée
            </div>
            <div class="arrival-time">
                {{ proposal.from?.date?.format('DD/MM HH:mm') }}
            </div>
        </div>
        <div class="row proposal__trip-info">
          <div class="col-5 location">
            <div class="city-name">{{ proposal.from?.from?.label }} </div>
            <div class="airport-name" *ngIf="proposal.from?.from?.airport">
                {{ proposal.from?.from?.airport?.name }}
            </div>
          </div>
          <div class="col-2 d-flex align-items-center">
            <mat-icon>chevron_right</mat-icon>
          </div>
          <div class="col-5 location">
            <div class="city-name">{{ proposal.from?.to.label }}</div>
            <div class="airport-name" *ngIf="proposal.from?.to.airport">
              {{ proposal.from?.to.airport.name }}
            </div>
          </div>
        </div>
    </div>
    <hr class="divider">
    <div class="d-flex w-100 justify-content-center" *ngIf="fromTrip; else requestLocation">
      <div *ngIf="proposal.airportPickup; else location"  class="proposal__request__city">
        <mat-icon>flight</mat-icon> Remise à l'aéroport
      </div>
      <ng-template #location>
        <div class="proposal__request__city" *ngIf="proposal.meetingPoint?.city; else meeting">
            <mat-icon>location_city</mat-icon> {{ proposal.meetingPoint.city }} ({{ proposal.meetingPoint.country }})
            {{ proposal.meetingPoint.address ? ', ' + proposal.meetingPoint?.address : '' }}
        </div>
        <ng-template #meeting>
          <div class="proposal__request__city">
            <mat-icon>location_on</mat-icon> Remise au point de rendez-vous (à définir)
          </div>
        </ng-template>
      </ng-template>            
    </div>
    <br>
    <div class="d-flex w-100 justify-content-center">
      <button class="btn btn-light btn-sm btn-icon mb-5"
              *ngIf="!proposal.closed && !proposal.accepted && !proposal.refused && proposal.bonus"
              (click)="modifyProposal()">
        <mat-icon>my_location</mat-icon> {{ proposal.meetingPoint?.city ? 'Proposer un autre lieu' : 'Proposer un lieu de rendez-vous'}}
      </button>
    </div>
</div>


<ng-template #fromRequest>
  <div class="proposal__request" *ngIf="!self">
    <h6 class="text-muted">Articles ({{proposal.from?.items?.length || 0}})</h6>
    <div *ngIf="!standalone; else fullArticles">
      <mat-card class="proposal__request__item" matRipple *ngFor="let item of proposal.from?.items">
        <mat-card-title>{{ item.label }}</mat-card-title>
      </mat-card>
    </div>
    <ng-template #fullArticles>
        <app-item class="proposal__request__item" [item]="item" [fullWidth]="true" [removable]="false"
                  *ngFor="let item of proposal.from?.items"></app-item>
    </ng-template>
    <div class="d-flex w-100 justify-content-center mt-5">
      <button (click)="openRequest(proposal.from)" class="btn btn-info">Voir l'annonce</button>
    </div>
  </div>
</ng-template>


<ng-template #requestLocation>
  <div class="row">
    <div [ngClass]="{'col-6': proposal.from?.urgent, 'col-12': !proposal.from?.urgent}">
      <div *ngIf="proposal.airportPickup; else location"  class="proposal__request__city">
        <mat-icon>flight</mat-icon> Remise à l'aéroport
      </div>
      <ng-template #location>
        <div class="proposal__request__city">
            <mat-icon>location_city</mat-icon> {{ proposal.meetingPoint?.city }} ({{ proposal.meetingPoint?.country }})
            {{ ', ' + proposal.meetingPoint?.address }}
        </div>
      </ng-template>            
    </div>
    <div class="col-6" *ngIf="proposal.from?.urgent">
      <mat-icon>today</mat-icon> {{ moment(proposal.from?.urgentDetails?.date).format('DD/MM/YYYY') }}
      <p *ngIf="!proposal.authorView && proposal.from?.urgentDetails?.explaination">
        Raison: " {{ proposal.from.urgentDetails.explaination }} "
      </p>
    </div>
  </div>
</ng-template>