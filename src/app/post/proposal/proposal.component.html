<div class="proposal-title-wrapper" *ngIf="standalone">
  <h2 class="proposal-title">Proposition</h2>
  <div class="proposal__author-details" *ngIf="proposal?.author">
      <app-avatar class="proposal__author-details__avatar"
                  [image]="proposal?.authorView ? proposal?.receiver?.avatar : proposal?.author?.avatar"
                  [size]="36"></app-avatar>
      <div class="proposal__author-details__personnal">
          {{ proposal?.authorView ? 'à ' + proposal?.receiver?.firstname : 'de ' + proposal?.author?.firstname }}
          <app-rating [rating]="proposal?.authorView ? proposal?.receiver?.rating : proposal?.author?.rating" [size]="36" [light]="true"></app-rating>
      </div>
  </div>
</div>
<div class="proposal__loading" *ngIf="!proposal">
  <mat-icon class="proposal__loading-icon">
    autorenew
  </mat-icon>
  <h4 class="proposal__loading-title">Chargement de la proposition</h4>
</div>
<div *ngIf="proposal"
     [ngClass]="{
       'proposal': true,
       'standalone container': standalone,
       'closed': standalone && (proposal.closed || proposal.refused)
     }">
    <div class="row justify-content-around proposal__actions">
        <button class="btn btn-light btn-icon mb-2"
                *ngIf="proposal.authorView && !proposal.closed && !proposal.accepted && !proposal.refused"
                (click)="modifyProposal()">
          <mat-icon>edit</mat-icon> Modifier
        </button>
        <button class="btn btn-danger btn-icon mb-2"
                [disabled]="proposal.closed"
                *ngIf="(proposal.authorView || proposal.closed) && !proposal.accepted && !proposal.refused"
                (click)="closeProposal()">
          <mat-icon>clear</mat-icon>{{ proposal.closed ? 'Annulée' : 'Annuler' }}
        </button>
        <button class="btn btn-success btn-icon mb-2"
                [disabled]="proposal.accepted || proposal.outdated"
                *ngIf="proposal.lastUpdate?.author.id !== currentUser.id &&
                       !proposal.refused && !proposal.closed && !proposal.paid"
                (click)="acceptProposal()">
          <mat-icon>done</mat-icon> {{ proposal.accepted ? 'Acceptée' : 'Accepter' }}
        </button>
        <button class="btn btn-success btn-icon mb-2"
                [disabled]="proposal.paid"
                (click)="payProposal()"
                *ngIf="
                (proposal.toRequest && receiver
                || proposal.fromRequest && proposal.authorView)
                && proposal.accepted">
          <mat-icon>credit_card</mat-icon> {{ proposal.paid ? 'Payée' : 'Payer' }}
        </button>
        <button class="btn btn-success btn-icon mb-2"
                [disabled]="proposal.validated"
                *ngIf="
                (proposal.toRequest && receiver
                || proposal.fromRequest && proposal.authorView)
                && proposal.paid"
                (click)="validateProposal()">
          <mat-icon>done_all</mat-icon> {{ proposal.validated ? 'Réception confirmée' : 'Confirmer la réception' }}
        </button>
        <button class="btn btn-success btn-icon mb-2" disabled
                *ngIf="(proposal.toTrip && receiver
                       || proposal.fromTrip && !receiver) && proposal.validated">
          <mat-icon>done_all</mat-icon> Livrée
        </button>
        <button class="btn btn-danger btn-icon mb-2"
                [disabled]="proposal.refused || proposal.outdated"
                *ngIf="(proposal.lastUpdate?.author.id !== currentUser.id && !proposal.accepted && !proposal.closed)
                      || (proposal.lastUpdate?.author.id === currentUser.id && proposal.refused)"
                (click)="refuseProposal()">
          <mat-icon>remove_circle_outline</mat-icon> {{ proposal.refused ? 'Refusée' : 'Refuser' }}
        </button>
    </div>
    <div class="d-flex justify-content-center text-align-center" *ngIf="!receiver && standalone">
      <small class="text-muted"
             *ngIf="proposal.lastUpdate?.author.id === currentUser.id
                    && !proposal.accepted && !proposal.refused && !proposal.closed">
        La proposition est en attente d'acceptation par {{ proposal?.to?.user.firstname }}
      </small>
      <small class="text-muted" *ngIf="(proposal.fromTrip || proposal.toRequest) && proposal.accepted && !proposal.paid">
        La proposition a été acceptée par {{ proposal?.to?.user.firstname }} et est en attente de paiement 
      </small>
      <small class="text-muted" *ngIf="(proposal.fromRequest || proposal.toTrip) && proposal.paid && !proposal.validated">
        Vos articles seront livrés par {{ proposal?.to?.user.firstname }} au plus tôt le {{ moment(proposal?.to?.date).format('DD/MM') }}
      </small>
      <div class="d-flex flex-column align-items-center"
          *ngIf="(proposal.fromRequest && !proposal.authorView
          || proposal.fromTrip && proposal.authorView)
          && proposal.paid && !proposal.validated">
        <button class="btn btn-warning" disabled>À livrer</button> <br>
        <small class="text-muted">La proposition a été reglée par {{ proposal?.to?.user.firstname }}. Articles à livrer</small>
        <div class="proposal__request__date" *ngIf="proposal.from?.urgent">
          <mat-icon>today</mat-icon> Avant le {{ moment(proposal.from?.urgentDetails?.date).format('DD/MM/YYYY') }}
          <p *ngIf="!proposal.authorView && proposal.from?.urgentDetails?.explaination">
            Raison: " {{ proposal.from.urgentDetails.explaination }} "
          </p>
        </div>
        <hr class="divider">
        <div class="d-flex w-100 justify-content-center" *ngIf="fromTrip; else requestLocation">
          <div *ngIf="proposal.airportPickup; else location"  class="proposal__request__city">
            <mat-icon>flight</mat-icon> Remise à l'aéroport
          </div>         
        </div>
      </div>
    </div>
    <div class="d-flex justify-content-center text-align-center" *ngIf="receiver && standalone">
      <small class="text-muted"
              *ngIf="proposal.lastUpdate?.author.id === currentUser.id
                    && !proposal.accepted && !proposal.refused && !proposal.closed">
        La proposition est en attente d'acceptation par {{ proposal?.from?.user.firstname }}
      </small>
      <small class="text-muted" *ngIf="(proposal.fromTrip || proposal.toRequest) && proposal.paid && !proposal.validated">
        Vos articles seront livrés par {{ proposal?.from?.user.firstname }} au plus tôt le {{ moment(proposal?.from?.date).format('DD/MM') }}
      </small>
      <small class="text-muted" *ngIf="(proposal.fromRequest || proposal.toTrip) && proposal.accepted && !proposal.paid">
        Vous avez accepté la proposition. En attente de paiement par {{ proposal?.from?.user.firstname }}
      </small>
      <div class="d-flex flex-column align-items-center"
           *ngIf="(proposal.fromRequest && !proposal.authorView
                  || proposal.fromTrip && proposal.authorView)
                  && proposal.paid && !proposal.validated">
        <button class="btn btn-warning" disabled>À livrer</button> <br>
        <small class="text-muted">La proposition a été reglée par {{ proposal?.from?.user.firstname }}. Articles à livrer</small>
        <div class="proposal__request__date" *ngIf="proposal.from?.urgent">
          <mat-icon>today</mat-icon> Avant le {{ moment(proposal.from?.urgentDetails?.date).format('DD/MM/YYYY') }}
          <p *ngIf="!proposal.authorView && proposal.from?.urgentDetails?.explaination">
            Raison: " {{ proposal.from.urgentDetails.explaination }} "
          </p>
        </div>
        <hr class="divider">
        <div class="d-flex w-100 justify-content-center" *ngIf="fromTrip; else requestLocation">
          <div *ngIf="proposal.airportPickup; else location"  class="proposal__request__city">
            <mat-icon>flight</mat-icon> Remise à l'aéroport
          </div>         
        </div>
      </div>
    </div>
    <hr class="divider" *ngIf="proposal.bonus">
    <div class="proposal__summary justify-content-center">
        <h6 class="proposal__summary__bonus text-muted" *ngIf="proposal.bonus !== null">Bonus voyageur: {{ proposal.bonus }} €</h6>
        <small class="proposal__summary__updates text-muted" *ngIf="proposal.lastUpdate">
          Dernière modification {{ moment(proposal.lastUpdate.date).fromNow() }} par
          {{ 
            proposal?.lastUpdate?.author?.id === currentUser?.id
            ? ' vous' : proposal.lastUpdate.author?.firstname || 'Oko user'
          }}
        </small>
        <div class="d-flex w-100 justify-content-center">
          <button class="btn btn-light btn-sm btn-icon"
                  [disabled]="proposal.accepted || proposal.refused"
                  *ngIf="!proposal.closed && !proposal.accepted && !proposal.refused && proposal.bonus"
                  (click)="updateProposalBonus()">
            <mat-icon>edit</mat-icon> Contre proposition
          </button>
        </div>
    </div>
    <hr class="divider" *ngIf="proposal.from && !self">
    <div *ngIf="receiver; else sender">
        <div class="proposal__summary" *ngIf="fromTrip; else fromRequest">
            <span *ngIf="standalone">Vous avez reçu une proposition de voyage de {{ proposal?.from.user.firstname }}</span>
            <app-proposal-trip [trip]="proposal?.from" (open)="openTrip($event)"></app-proposal-trip>
            <div *ngIf="standalone">
                <hr class="divider">
                Concernant votre annonce:
                <app-proposal-request [own]="true" [request]="proposal?.to" [fullDisplay]="standalone" (open)="openRequest($event)"></app-proposal-request>
            </div>
        </div>
    </div>
    <ng-template #sender>
      <div class="proposal__summary" *ngIf="toTrip; else toRequest">
        <span *ngIf="standalone">Vous avez fait une demande pour le voyage de {{ proposal?.to.user.firstname }}</span>
        <app-proposal-trip [trip]="proposal?.to" (open)="openTrip($event)"></app-proposal-trip>
        <div *ngIf="standalone">
          <hr class="divider">
          Concernant votre annonce:
          <app-proposal-request [own]="true" [request]="proposal?.from" [fullDisplay]="standalone" (open)="openRequest($event)"></app-proposal-request>
        </div>
      </div>
    </ng-template>
    
    <!-- Do not display if proposal is to be delivered-->
    <div *ngIf="!((proposal.fromRequest && receiver 
                  || proposal.fromTrip && proposal.authorView) 
                  && proposal.paid && !proposal.validated)">
      <hr class="divider">
      <div class="d-flex w-100 justify-content-center" *ngIf="fromTrip; else requestLocation">
        <div *ngIf="proposal.airportPickup; else location"  class="proposal__request__city">
          <mat-icon>flight</mat-icon> Remise à l'aéroport
        </div>         
      </div>
    </div>

    <br>
    <div class="d-flex w-100 justify-content-center">
      <button class="btn btn-light btn-sm btn-icon mb-5"
              [disabled]="proposal.accepted || proposal.refused"
              *ngIf="!proposal.closed && !proposal.accepted && !proposal.refused && proposal.bonus"
              (click)="updateProposalMeeting()">
        <mat-icon>my_location</mat-icon> {{ proposal.meetingPoint?.city ? 'Proposer un autre lieu' : 'Proposer un lieu de rendez-vous'}}
      </button>
    </div>
    <div class="d-flex justify-content-center mt-3 mb-3" *ngIf="!own">
      <button class="btn btn-light btn-icon" (click)="contact()">
        <mat-icon>mail_outline</mat-icon> Contacter {{ proposal.authorView ? proposal.receiver.firstname : proposal.author.firstname }}
      </button>
    </div>
</div>


<ng-template #fromRequest>
  <div class="proposal__request" *ngIf="!self && proposal.fromRequest; else toRequestAsSender">
    <span *ngIf="standalone">Vous avez reçu une demande de transport de {{ proposal?.from.user.firstname }}</span>
    <app-proposal-request [request]="proposal?.from" [fullDisplay]="standalone" (open)="openRequest($event)"></app-proposal-request>
    <div *ngIf="standalone">
      <hr class="divider">
      Concernant votre voyage:
      <app-proposal-trip [trip]="proposal?.to" (open)="openTrip($event)"></app-proposal-trip>
    </div>
  </div>
</ng-template>

<ng-template #fromRequestAsSender>
    <div class="proposal__request" *ngIf="!self">
      <app-proposal-request [request]="proposal?.from" [fullDisplay]="standalone" (open)="openRequest($event)"></app-proposal-request>
    </div>
  </ng-template>

<ng-template #toRequest>
  <div class="proposal__request" *ngIf="!self && proposal.toRequest; else fromRequestAsSender">
    <span *ngIf="standalone">Vous avez proposé un voyage pour l'annonce de {{ proposal?.to.user.firstname }}</span>
    <app-proposal-request [request]="proposal?.to" [fullDisplay]="standalone" (open)="openRequest($event)"></app-proposal-request>
    <div *ngIf="standalone">
      <hr class="divider">
      Votre voyage:
      <app-proposal-trip [trip]="proposal?.from" (open)="openTrip($event)"></app-proposal-trip>
    </div>
  </div>
</ng-template>

<ng-template #toRequestAsSender>
  <div class="proposal__request" *ngIf="!self">
    <app-proposal-request [request]="proposal?.to" [fullDisplay]="standalone" (open)="openRequest($event)"></app-proposal-request>
  </div>
</ng-template>

<ng-template #requestLocation>
  <div class="row">
    <div [ngClass]="{'col-6': proposal.from?.urgent, 'col-12': !proposal.from?.urgent}">
      <div *ngIf="proposal.airportPickup; else location"  class="proposal__request__city">
        <mat-icon>flight</mat-icon> Remise à l'aéroport
      </div>       
    </div>
    <div class="col-6 proposal__request__date" *ngIf="proposal.from?.urgent">
      <mat-icon>today</mat-icon> Avant le {{ moment(proposal.from?.urgentDetails?.date).format('DD/MM/YYYY') }}
      <p *ngIf="!proposal.authorView && proposal.from?.urgentDetails?.explaination">
        Raison: " {{ proposal.from.urgentDetails.explaination }} "
      </p>
    </div>
  </div>
</ng-template>

<ng-template #location>
  <div class="proposal__request__city"
        *ngIf="proposal.meetingPoint?.city && proposal.meetingPoint?.city !== '' 
              && proposal.meetingPoint?.address && proposal.meetingPoint?.address !== ''; else meeting">
      <app-address-display [meetingPoint]="proposal?.meetingPoint"></app-address-display>
  </div>
  <ng-template #meeting>
    <div class="proposal__request__city">
      <mat-icon>location_on</mat-icon> Remise au point de rendez-vous <br> (à définir)
    </div>
  </ng-template>
</ng-template>   